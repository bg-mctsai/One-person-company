rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========== ğŸ”§ Helper Functions ==========
    
    // åˆ¤æ–·æ˜¯å¦ç”± Firebase Admin SDKï¼ˆå¦‚ Cloud Functionsï¼‰ç™¼å‡ºï¼ˆç„¡ request.authï¼‰
    function isFromFunction() {
      return request.auth == null;
    }
    
    // åˆ¤æ–·æ˜¯å¦ç‚ºç™»å…¥ä½¿ç”¨è€…ï¼ˆæœ‰ request.authï¼‰
    function isSignedIn() {
      return request.auth != null;
    }
    
    // åˆ¤æ–·æ˜¯å¦ç‚ºç®¡ç†å“¡
    function isAdmin() {
      return request.auth != null && 
             (request.auth.token.admin == true || 
              request.auth.token.roles != null && 
              request.auth.token.roles.hasAny(['admin', 'ç®¡ç†å“¡']));
    }
    
    // åˆ¤æ–·æ˜¯å¦ç‚ºç•¶å‰ç”¨æˆ¶
    function isCurrentUser(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // ========== å…¬å…±æ•¸æ“šï¼ˆåªè®€ï¼‰ ==========
    match /public/{document=**} {
      allow read: if true;
      allow write: if isFromFunction() || isAdmin();
    }
    
    // ========== ç”¨æˆ¶æ•¸æ“š ==========
    match /users/{userId} {
      // ç”¨æˆ¶è³‡æ–™ï¼ˆç”¨æˆ¶è‡ªå·±å¯è®€å¯«ï¼‰
      match /profile {
        allow read: if isFromFunction() || isCurrentUser(userId);
        allow write: if isFromFunction() || isCurrentUser(userId);
      }
      
      // éŠæˆ²é€²åº¦ï¼ˆç”¨æˆ¶è‡ªå·±å¯è®€å¯«ï¼‰
      match /progress {
        allow read: if isFromFunction() || isCurrentUser(userId);
        allow write: if isFromFunction() || isCurrentUser(userId);
      }
      
      // æŒ‘æˆ°è¨˜éŒ„ï¼ˆç”¨æˆ¶è‡ªå·±å¯è®€å¯«ï¼‰
      match /challenges/{challengeId} {
        allow read: if isFromFunction() || isCurrentUser(userId);
        allow create: if isFromFunction() || isCurrentUser(userId);
        allow update: if isFromFunction() || 
                        (isCurrentUser(userId) && 
                         request.resource.data.userId == userId);
        allow delete: if false; // ä¸å…è¨±åˆªé™¤
      }
      
      // å°è©±æœƒè©±ï¼ˆç”¨æˆ¶è‡ªå·±å¯è®€å¯«ï¼‰
      match /dialogues/{sessionId} {
        allow read: if isFromFunction() || isCurrentUser(userId);
        allow create: if isFromFunction() || isCurrentUser(userId);
        allow update: if isFromFunction() || 
                        (isCurrentUser(userId) && 
                         request.resource.data.userId == userId);
        allow delete: if isFromFunction() || isCurrentUser(userId);
      }
      
      // æƒ…ç·’ç‹€æ…‹ï¼ˆç”¨æˆ¶è‡ªå·±å¯è®€å¯«ï¼‰
      match /emotions/{npcId} {
        allow read: if isFromFunction() || isCurrentUser(userId);
        allow write: if isFromFunction() || isCurrentUser(userId);
      }
      
      // é—œä¿‚ç‹€æ…‹ï¼ˆç”¨æˆ¶è‡ªå·±å¯è®€å¯«ï¼‰
      match /relationships/{npcId} {
        allow read: if isFromFunction() || isCurrentUser(userId);
        allow write: if isFromFunction() || isCurrentUser(userId);
      }
    }
    
    // ========== å¯¦æ™‚æœƒè©±ï¼ˆå¯é¸ï¼‰ ==========
    match /sessions/{sessionId} {
      allow read: if isFromFunction() || isSignedIn();
      allow create: if isFromFunction() || isSignedIn();
      allow update: if isFromFunction() || 
                      (isSignedIn() && 
                       (request.resource.data.userId == request.auth.uid ||
                        resource.data.userId == request.auth.uid));
      allow delete: if isFromFunction() || 
                      (isSignedIn() && 
                       resource.data.userId == request.auth.uid);
    }
  }
}

