# Options Data 格式（對話輪次/發話流程/產製策略）

> 目的：定義「每輪誰先說話」與「2 個毒舌提示選項 + 1 個自由輸入」的可落地資料結構。  
> 核心原則：**勝負由規則引擎（屬性/輪次/閾值）決定；AI 只做 NPC 回覆的表演文本。**  
> 輸入模式：**每次挑戰都必須有自由輸入；2 個選項是毒舌系統的提示，告知玩家可以選的策略方向。**

---

## 1) 對話輪次（硬流程）

### 1.1 單 keyNpc（最常見）

固定節奏（每幕重複）：

1. **進場**：載入 `MomentSpec`（見 `Moment Spec 表.md`） → 套用 `entryOverrides` → 產生 NPC 屬性「進場快照」
2. **開場台詞**：`keyNpc` 先說 1 句（可模板或 AI）
3. **Round i（迴圈）**：
   - 玩家輸入方式（三選一）：
     - **自由輸入**：玩家直接輸入文字（主要方式）
     - **毒舌提示選項 1**：點擊第一個提示選項（作為策略參考）
     - **毒舌提示選項 2**：點擊第二個提示選項（作為策略參考）
   - 玩家輸入的文字會由 AI 解析為 `optionType`（+可選 tags）
   - 規則引擎依 `optionType`（+可選 tags）更新屬性
   - 規則引擎把更新後的屬性映射為表層情緒（`出場角色.md`）
   - `keyNpc` 回 1–2 句（AI 或模板，參考玩家輸入）
   - 檢查 **成功/失手**：
     - 成功：命中 `targetEmotion` 或 `targetAttrThresholds`
     - 失手：`turnsLeft==0` 或 命中 `failHard`
4. **離場**：成功產出固定 `clueId`；失手進 `復活機制.md` 的回溯（看訊息回到 5 分鐘前）

### 1.2 多 NPC（同幕多人在場）

仍以 `keyNpc` 為主，其他人只能「插話」，不主導判定。

**插話規則（deterministic，避免劇情爆炸）**

- 每輪最多 **1 次插話**
- 插話優先級（高→低）：
  1. **supportNpc** 命中「插話觸發」條件（例如：同事A.恐懼>=70 → 露出破綻）
  2. `keyNpc` 受到玩家選項 `tag=證據` → 其他人先沉默（本輪不插話）
  3. 預設：不插話

插話發生時，輸出順序固定：

`keyNpc`（回應）→ `supportNpc`（插 1 句）→ 下一輪玩家選項

> 注意：不做「A→B→玩家→B→玩家…」那種多主角輪替（會讓輪次/判定/內容產能爆炸）。  
> 你要的沉浸與可控，最佳解是：**永遠只有一個 keyNpc 主導對話節奏**。

---

## 2) Options Data Schema（建議最小可跑版）

> 這份 schema 支援「2 個毒舌提示選項 + 1 個自由輸入」模式。  
> 選項是毒舌系統的提示，告知玩家可以選的策略方向；玩家主要透過自由輸入與 NPC 對話。

### 2.1 Type 定義（概念）

- `MomentConfig`
  - `momentId`
  - `opening`
  - `rounds[]`
  - `supportInterjections[]`（可選）
- `RoundConfig`
  - `roundId`
  - `npcPrompt`（給 AI 的 prompt seed 或模板 key）
  - `tongueHints[]`（2 個毒舌提示選項）
  - `inputMode`：`"freeText"`（固定為自由輸入模式）
  - `inputValidation`（可選）：輸入驗證規則
- `TongueHint`（毒舌提示選項）
  - `id`
  - `text`（顯示文字，作為策略提示）
  - `optionType`：積極對抗 / 溫和堅持 / 情感訴求 / 順從消極
  - `tags`（可選）：證據 / 界線 / 後果 / 反問 / 退縮
  - `tongueComment`（可選）：點擊此選項時，毒舌系統的額外評論
  - `說明`：玩家點擊此選項時，會將 `text` 作為輸入文字提交，等同於玩家輸入這段文字

### 2.2 JSON 範例（Moment 7：被推卸責任，5 輪）

```json
{
  "momentId": 7,
  "opening": {
    "speaker": "主管",
    "mode": "ai",
    "npcPrompt": "冷、短句、壓迫感；先問責"
  },
  "rounds": [
    {
      "roundId": 1,
      "npcPrompt": "主管：問你延誤怎麼解釋（冷漠）",
      "inputMode": "freeText",
      "inputValidation": {
        "minLength": 5,
        "maxLength": 100,
        "rejectPatterns": ["遊戲", "關卡", "玩家", "挑戰", "UI"]
      },
      "tongueHints": [
        {
          "id": "r1_hint1",
          "text": "我先把時間線講清楚：我在 XX 日完成交付，延誤發生在後續轉交。",
          "optionType": "溫和堅持",
          "tags": ["證據"],
          "tongueComment": "你終於知道要拿證據了。"
        },
        {
          "id": "r1_hint2",
          "text": "這不是我造成的。請你先看我這份交付紀錄。",
          "optionType": "積極對抗",
          "tags": ["證據", "界線"],
          "tongueComment": "對，就是這樣。別再道歉了。"
        }
      ]
    }
  ],
  "supportInterjections": [
    {
      "npc": "同事A",
      "priority": 10,
      "when": "同事A.恐懼>=70",
      "lineMode": "template",
      "templateKey": "interject.threatened.1"
    }
  ]
}
```

### 2.3 玩家輸入處理流程

1. **玩家輸入文字**（自由輸入框）
   - 或點擊毒舌提示選項（等同輸入該選項的 `text`）
2. **呼叫 `parsePlayerInput` function**（新增）
   - 輸入：`playerText`, `momentId`, `roundId`, `availableOptionTypes`
   - 輸出：`optionType`, `tags`, `confidence`, `parsedIntent`
3. **規則引擎處理**
   - 依解析出的 `optionType` + `tags` 更新 NPC 屬性
   - 映射為表層情緒
4. **NPC 回覆生成**
   - 呼叫 `generateNpcReply`（參考玩家輸入）
   - 回傳 1–2 句 NPC 回應

---

## 3) 產製策略（我幫你定死）

### 3.1 MVP（推薦）：**2 個毒舌提示選項 + 自由輸入 + AI 解析 + AI 回覆**

- **毒舌提示選項（TongueHint）**：你寫死 2 個（作為策略提示）
  - 定位：毒舌系統告知玩家「可以選的方向」
  - 好處：降低學習成本、提供策略參考、保持遊戲平衡
  - 設計原則：每個提示代表不同策略（例如：一個溫和堅持、一個積極對抗）
- **玩家自由輸入**：主要互動方式
  - 玩家直接輸入文字表達想法
  - 必須實作 `parsePlayerInput` function 解析為 `optionType`
- **NPC 回覆（npc_reply）**：AI 生成 1–2 句
  - 參考玩家輸入內容生成回應
  - AI 輸出只影響「顯示」，不影響判定（判定由規則引擎決定）

### 3.2 毒舌提示選項設計原則

- **數量**：固定 2 個
- **策略多樣性**：2 個提示應代表不同策略（例如：溫和堅持 vs 積極對抗）
- **毒舌評論**：每個提示可帶 `tongueComment`，點擊時顯示毒舌系統的額外評論
- **範例設計**：
  - 提示 1：溫和堅持型（帶證據）
  - 提示 2：積極對抗型（帶證據+界線）
  - 避免：兩個提示都是同一策略（失去提示意義）

### 3.3 玩家輸入解析策略

- **AI 解析**：使用 `parsePlayerInput` function
  - 輸入玩家文字
  - 解析為 `optionType`（積極對抗/溫和堅持/情感訴求/順從消極）
  - 識別 `tags`（證據/界線/後果/反問/退縮）
  - 回傳 `confidence`（解析信心度）
- **容錯機制**：
  - 如果 AI 解析失敗或信心度過低，可回退到「最接近的毒舌提示選項」
  - 或提示玩家「再試一次，說得更具體一點」
- **輸入驗證**：
  - 長度限制：5–100 字
  - 禁用詞檢查：遊戲/關卡/玩家/挑戰/UI
  - 即時反饋：輸入時顯示策略識別提示

---

## 4) 禁用詞與風格約束（對齊介面字串）

- 顯示文本（NPC/玩家輸入/毒舌提示選項）不可出現：遊戲/關卡/玩家/挑戰/UI（見 `介面字串表.md`）
- NPC 回覆長度：1–2 句（短、狠、帶壓迫/甜/冷依角色）
- 玩家輸入長度：5–100 字（前端驗證）
- 毒舌提示選項：每個提示 20–50 字（作為策略範例）

---

## 5) 前端 UI 設計建議

### 5.1 輸入介面布局

```
┌─────────────────────────────────┐
│ [NPC 對話框]                    │
│ 主管：這次延誤，你負責的部分     │
│ 怎麼解釋？                       │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ [你的回應]                       │
│ ┌─────────────────────────────┐ │
│ │ [輸入框：玩家自由輸入]       │ │
│ │                              │ │
│ └─────────────────────────────┘ │
│                                  │
│ 💡 毒舌提示（可選）：            │
│ [提示 1] 我先把時間線講清楚...   │
│ [提示 2] 這不是我造成的...       │
└─────────────────────────────────┘
```

### 5.2 互動流程

1. **預設狀態**：顯示自由輸入框 + 2 個毒舌提示選項（小按鈕）
2. **玩家輸入時**：
   - 即時顯示策略識別：「看起來你想用『積極對抗』的策略」
   - 關鍵詞高亮（證據/時間線/界線等）
3. **點擊毒舌提示**：
   - 將提示文字填入輸入框（可編輯）
   - 顯示毒舌評論（如果有 `tongueComment`）
4. **提交輸入**：
   - 驗證長度和禁用詞
   - 呼叫 `parsePlayerInput` 解析
   - 如果解析失敗，提示「再試一次」或使用最接近的提示選項

