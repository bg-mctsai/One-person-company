# Moment Configs 驗證腳本

> 目的：提供完整的驗證腳本，檢查所有 14 個 moment-configs JSON 文件的完整性和正確性。  
> 依賴文件：`moment-configs/moment-*.json`、`Moment Spec 表.md`、`Options Data 格式.md`、`介面字串表.md`。

---

## 驗證項目

### 1. 文件完整性檢查

- [ ] 所有 14 個 moment-configs 文件存在
- [ ] 每個文件的 `momentId` 與文件名對應
- [ ] 每個文件的 JSON 格式正確

### 2. 數據結構檢查

- [ ] 每個文件的 `maxTurns` 與 `rounds` 數量一致
- [ ] 每個文件的 `target` 格式正確
- [ ] 每個文件的 `failHard` 格式正確
- [ ] 每個文件的 `opening` 格式正確
- [ ] 每個文件的 `rounds` 格式正確
- [ ] 每個文件的 `supportInterjections` 格式正確（可選）

### 3. 內容完整性檢查

- [ ] 每個 round 至少有 3 個選項
- [ ] 每個選項都有 `optionType`（積極對抗/溫和堅持/情感訴求/順從消極）
- [ ] 每個選項都有 `tags`（至少 1 個）
- [ ] 每個選項的文字符合沉浸用語規範（無禁用詞）
- [ ] 每個 NPC prompt 符合角色性格

### 4. 對應關係檢查

- [ ] `Moment Spec 表.md` 的配置與 `moment-configs/moment-*.json` 一致
- [ ] `clueId` 與 `線索系統實現.md` 的線索定義對應
- [ ] `seedMap` 與 `金手指提示庫.md` 的 seed 定義對應
- [ ] `entryOverrides` 與 `出場角色.md` 的屬性定義對應
- [ ] `templateKey` 與 `插話模板庫.md` 的模板定義對應

---

## TypeScript 驗證腳本

```typescript
// scripts/validateMomentConfigs.ts
import fs from 'fs';
import path from 'path';

// 禁用詞列表（從 介面字串表.md 提取）
const FORBIDDEN_WORDS = ['遊戲', '關卡', '玩家', '挑戰', 'UI'];

// 選項類型列表
const VALID_OPTION_TYPES = ['積極對抗', '溫和堅持', '情感訴求', '順從消極'];

// Moment Spec 表配置（從 Moment Spec 表.md 提取）
const MOMENT_SPECS: Record<number, {
  momentId: number;
  date: string;
  category: string;
  title: string;
  maxTurns: number;
  keyNpc: string;
  supportNpcs: string[];
  target: string;
  failHard: string[];
  entryOverrides?: string;
  clueId?: string;
  seedMap?: string;
}> = {
  1: { momentId: 1, date: '2019/01/10', category: '職場', title: '初入職場的歡迎', maxTurns: 3, keyNpc: '同事A', supportNpcs: [], target: 'targetEmotion=好感', failHard: ['同事A.警戒>=80'] },
  2: { momentId: 2, date: '2019/03/15', category: '職場', title: '第一次合作', maxTurns: 4, keyNpc: '同事A', supportNpcs: [], target: 'targetEmotion=尊重', failHard: ['同事A.警戒>=85'] },
  3: { momentId: 3, date: '2019/05/20', category: '職場', title: '職場聚會', maxTurns: 4, keyNpc: '同事群', supportNpcs: [], target: 'targetEmotion=尊重', failHard: ['同事群.傳播性>=90'] },
  4: { momentId: 4, date: '2019/06/01', category: '情人', title: '第一次約會', maxTurns: 3, keyNpc: '情人C', supportNpcs: [], target: 'targetEmotion=好感', failHard: ['情人C.警戒>=85'] },
  5: { momentId: 5, date: '2019/07/01', category: '職場', title: '第一次被推卸責任', maxTurns: 5, keyNpc: '主管', supportNpcs: ['同事A'], target: 'targetEmotion=尊重', failHard: ['主管.警戒>=90 或 主管.壓力>=95'] },
  6: { momentId: 6, date: '2019/07/15', category: '職場', title: '第一次被搶功', maxTurns: 5, keyNpc: '主管', supportNpcs: ['同事A'], target: 'targetEmotion=尊重', failHard: ['主管.憤怒>=85 且 主管.尊重<35'] },
  7: { momentId: 7, date: '2019/09/10', category: '職場', title: '被推卸責任', maxTurns: 5, keyNpc: '主管', supportNpcs: ['同事A'], target: 'targetEmotion=尊重', failHard: ['主管.警戒>=90 或 主管.壓力>=95'] },
  8: { momentId: 8, date: '2019/11/05', category: '職場', title: '被當成工具', maxTurns: 5, keyNpc: '同事A', supportNpcs: ['主管'], target: 'targetEmotion=震驚', failHard: ['同事A.警戒>=95'] },
  9: { momentId: 9, date: '2019/07/25', category: '情人', title: '情人的謊言', maxTurns: 5, keyNpc: '情人C', supportNpcs: [], target: 'targetEmotion=愧疚', failHard: ['情人C.逃避>=95'] },
  10: { momentId: 10, date: '2019/09/30', category: '情人', title: '不在照片裡的戀人', maxTurns: 6, keyNpc: '情人C', supportNpcs: [], target: 'targetEmotion=尊重', failHard: ['情人C.警戒>=90 且 情人C.尊重<25'] },
  11: { momentId: 11, date: '2020/02/10', category: '職場', title: '被陷害離職', maxTurns: 7, keyNpc: 'HR', supportNpcs: ['主管', '同事A'], target: 'attrThresholds: HR.尊重>=65', failHard: ['HR.警戒>=95', 'HR.壓力>=95 且 HR.警戒>=85'] },
  12: { momentId: 12, date: '2020/04/05', category: '職場', title: '職場名聲被毀', maxTurns: 7, keyNpc: '同事群', supportNpcs: ['同事A'], target: 'attrThresholds: 同事群.尊重>=55 且 同事群.傳播性<=35', failHard: ['同事群.傳播性>=95'] },
  13: { momentId: 13, date: '2020/02/25', category: '情人', title: '情人的徹底傷害', maxTurns: 7, keyNpc: '情人C', supportNpcs: ['旁人'], target: 'targetEmotion=尊重', failHard: ['情人C.警戒>=95', '情人C.壓力>=95'] },
  14: { momentId: 14, date: '2020/06/15', category: '自我', title: '最後的求救', maxTurns: 8, keyNpc: '過去的自己', supportNpcs: [], target: 'attrThresholds: 過去的自己.內在力量>=65 且 過去的自己.絕望<=40', failHard: ['過去的自己.絕望>=98'] },
};

interface MomentConfig {
  momentId: number;
  date: string;
  category: string;
  title: string;
  maxTurns: number;
  keyNpc: string;
  supportNpcs: string[];
  target: { type: string; value: string | string[] };
  failHard: string[];
  opening: { speaker: string; mode: string; npcPrompt: string };
  rounds: Array<{
    roundId: number;
    npcPrompt: string;
    options: Array<{
      id: string;
      text: string;
      optionType: string;
      tags: string[];
    }>;
  }>;
  supportInterjections?: Array<{
    npc: string;
    priority: number;
    when: string;
    lineMode: string;
    templateKey: string;
  }>;
}

function validateMomentConfigs(): boolean {
  const errors: string[] = [];
  const warnings: string[] = [];
  const configsDir = path.join(__dirname, '../企劃/moment-configs');

  // 檢查所有 14 個時刻都存在
  for (let i = 1; i <= 14; i++) {
    const filePath = path.join(configsDir, `moment-${i}.json`);
    
    if (!fs.existsSync(filePath)) {
      errors.push(`時刻 ${i} 文件不存在: ${filePath}`);
      continue;
    }

    let config: MomentConfig;
    try {
      const fileContent = fs.readFileSync(filePath, 'utf-8');
      config = JSON.parse(fileContent);
    } catch (e) {
      errors.push(`時刻 ${i} JSON 格式錯誤: ${e}`);
      continue;
    }

    // 檢查 momentId 與文件名對應
    if (config.momentId !== i) {
      errors.push(`時刻 ${i}: momentId (${config.momentId}) 與文件名不一致`);
    }

    // 檢查 maxTurns 與 rounds 數量一致
    if (config.maxTurns !== config.rounds.length) {
      errors.push(`時刻 ${i}: maxTurns (${config.maxTurns}) 與 rounds 數量 (${config.rounds.length}) 不一致`);
    }

    // 檢查每個 round 至少有 3 個選項
    config.rounds.forEach((round, idx) => {
      if (round.options.length < 3) {
        errors.push(`時刻 ${i} Round ${idx + 1}: 選項數量不足 3 個 (只有 ${round.options.length} 個)`);
      }

      // 檢查每個選項的格式
      round.options.forEach((option, optIdx) => {
        // 檢查 optionType
        if (!VALID_OPTION_TYPES.includes(option.optionType)) {
          errors.push(`時刻 ${i} Round ${idx + 1} Option ${optIdx + 1}: 無效的 optionType "${option.optionType}"`);
        }

        // 檢查 tags
        if (!option.tags || option.tags.length === 0) {
          errors.push(`時刻 ${i} Round ${idx + 1} Option ${optIdx + 1}: 缺少 tags`);
        }

        // 檢查禁用詞
        FORBIDDEN_WORDS.forEach(word => {
          if (option.text.includes(word)) {
            errors.push(`時刻 ${i} Round ${idx + 1} Option ${optIdx + 1}: 包含禁用詞 "${word}"`);
          }
        });

        // 檢查 NPC prompt 中的禁用詞
        FORBIDDEN_WORDS.forEach(word => {
          if (round.npcPrompt.includes(word)) {
            errors.push(`時刻 ${i} Round ${idx + 1} NPC Prompt: 包含禁用詞 "${word}"`);
          }
        });
      });
    });

    // 檢查與 Moment Spec 表的對應
    const spec = MOMENT_SPECS[i];
    if (spec) {
      if (config.date !== spec.date) {
        warnings.push(`時刻 ${i}: date (${config.date}) 與 Moment Spec 表 (${spec.date}) 不一致`);
      }
      if (config.category !== spec.category) {
        warnings.push(`時刻 ${i}: category (${config.category}) 與 Moment Spec 表 (${spec.category}) 不一致`);
      }
      if (config.title !== spec.title) {
        warnings.push(`時刻 ${i}: title (${config.title}) 與 Moment Spec 表 (${spec.title}) 不一致`);
      }
      if (config.maxTurns !== spec.maxTurns) {
        warnings.push(`時刻 ${i}: maxTurns (${config.maxTurns}) 與 Moment Spec 表 (${spec.maxTurns}) 不一致`);
      }
      if (config.keyNpc !== spec.keyNpc) {
        warnings.push(`時刻 ${i}: keyNpc (${config.keyNpc}) 與 Moment Spec 表 (${spec.keyNpc}) 不一致`);
      }
    }

    // 檢查 supportInterjections 的 templateKey
    if (config.supportInterjections) {
      config.supportInterjections.forEach((interjection, idx) => {
        // 這裡可以檢查 templateKey 是否存在於 插話模板庫.md
        // 暫時只檢查格式
        if (!interjection.templateKey || !interjection.templateKey.startsWith('interject.')) {
          warnings.push(`時刻 ${i} SupportInterjection ${idx + 1}: templateKey 格式可能不正確 "${interjection.templateKey}"`);
        }
      });
    }
  }

  // 輸出結果
  if (errors.length > 0) {
    console.error('❌ 驗證失敗：');
    errors.forEach(error => console.error(`  - ${error}`));
  }

  if (warnings.length > 0) {
    console.warn('⚠️  警告：');
    warnings.forEach(warning => console.warn(`  - ${warning}`));
  }

  if (errors.length === 0 && warnings.length === 0) {
    console.log('✅ 驗證通過！所有 moment-configs 文件完整且正確。');
    return true;
  }

  return errors.length === 0;
}

// 執行驗證
if (require.main === module) {
  const success = validateMomentConfigs();
  process.exit(success ? 0 : 1);
}

export { validateMomentConfigs };
```

---

## 使用方式

### 1. 安裝依賴

```bash
npm install --save-dev typescript @types/node
```

### 2. 編譯腳本

```bash
npx tsc scripts/validateMomentConfigs.ts
```

### 3. 執行驗證

```bash
node scripts/validateMomentConfigs.js
```

### 4. 整合到 CI/CD

```json
{
  "scripts": {
    "validate:moments": "ts-node scripts/validateMomentConfigs.ts",
    "precommit": "npm run validate:moments"
  }
}
```

---

## 驗證結果範例

### ✅ 成功範例

```
✅ 驗證通過！所有 moment-configs 文件完整且正確。
```

### ❌ 失敗範例

```
❌ 驗證失敗：
  - 時刻 5: maxTurns (5) 與 rounds 數量 (4) 不一致
  - 時刻 7 Round 3 Option 2: 包含禁用詞 "遊戲"
  - 時刻 10 Round 1: 選項數量不足 3 個 (只有 2 個)

⚠️  警告：
  - 時刻 3: date (2019/05/21) 與 Moment Spec 表 (2019/05/20) 不一致
```

---

## 擴充建議

### 1. 檢查線索對應

可以擴充腳本，檢查 `clueId` 是否在 `線索系統實現.md` 中定義。

### 2. 檢查插話模板

可以擴充腳本，檢查 `templateKey` 是否在 `插話模板庫.md` 中定義。

### 3. 檢查屬性對應

可以擴充腳本，檢查 `entryOverrides` 中的屬性是否在 `出場角色.md` 中定義。

### 4. 檢查種子對應

可以擴充腳本，檢查 `seedMap` 中的種子是否在 `金手指提示庫.md` 中定義。

---

## 總結

驗證腳本包括：

1. **文件完整性檢查**：確保所有 14 個文件存在且格式正確
2. **數據結構檢查**：確保所有必要欄位存在且格式正確
3. **內容完整性檢查**：確保選項數量、類型、標籤等符合規範
4. **對應關係檢查**：確保與 Moment Spec 表、其他文檔一致

建議在每次修改 moment-configs 後執行驗證，確保數據完整性。

