# 線索系統實現（具體機制）

> 目的：定義線索的收集、顯示、分析、推理的完整實現機制。  
> 依賴文件：`完整故事情節.md`（線索內容）、`Moment Spec 表.md`（clueId）、`計分公式.md`（t 真相分）。

---

## 1) 線索類型與結構

### 1.1 線索數據結構

```typescript
interface Clue {
  id: string;                    // CLUE-01 ~ CLUE-14
  momentId: number;              // 來源時刻
  title: string;                 // 線索標題（簡短）
  description: string;           // 線索描述（詳細）
  type: '隱藏' | '關鍵' | '累積' | '最終';
  category: '職場' | '辦公室霸凌延伸' | '自我';
  relatedNpcs: string[];         // 相關 NPC（同事A、主管、同事C）
  tags: string[];               // 標籤（偽裝、試探、監視、通報、說謊、被威脅）
  discoveredAt: Timestamp;       // 發現時間
  isKeyClue: boolean;            // 是否為關鍵線索（CLUE-11~14）
}
```

### 1.2 14 個固定線索定義

| clueId | momentId | title | description | type | relatedNpcs | tags |
|--------|----------|-------|-------------|------|-------------|------|
| CLUE-01 | 1 | 過度熱情 | 同事A的「過度熱情」可能是偽裝 | 隱藏 | 同事A | MASK, PROBE |
| CLUE-02 | 2 | 稱讚試探 | 同事A的「稱讚」可能是試探 | 隱藏 | 同事A | PROBE |
| CLUE-03 | 3 | 觀察監視 | 主管的「觀察」可能是監視 | 隱藏 | 主管 | WATCH |
| CLUE-04 | 4 | 發送訊息 | 同事C的「發送訊息」可能是通報 | 隱藏 | 同事C | REPORT |
| CLUE-05 | 5 | 閃爍眼神 | 同事C的「閃爍眼神」可能是說謊 | 隱藏 | 同事C | LIE |
| CLUE-06 | 6 | 閃爍眼神 | 主管的「閃爍眼神」可能是知情 | 隱藏 | 主管 | KNOW |
| CLUE-07 | 7 | 害怕眼神 | 同事A的「害怕眼神」可能是被威脅 | 隱藏 | 同事A | THREATENED |
| CLUE-08 | 8 | 點頭示意 | 同事A的「點頭示意」可能是串通 | 隱藏 | 同事A | COLLUSION |
| CLUE-09 | 9 | 閃爍眼神 | 同事C的「閃爍眼神」可能是說謊 | 隱藏 | 同事C | LIE |
| CLUE-10 | 10 | 發送訊息 | 同事C的「發送訊息」可能是通報 | 隱藏 | 同事C | REPORT |
| CLUE-11* | 11 | 被威脅 | 主管的「害怕」可能是被威脅 | 關鍵 | 主管 | THREATENED, KNOW |
| CLUE-12* | 12 | 被威脅 | 同事A的「害怕」可能是被威脅 | 關鍵 | 同事A | THREATENED, RUMOR |
| CLUE-13* | 13 | 被威脅 | 同事C的「害怕」可能是被威脅 | 關鍵 | 同事C | THREATENED, SHAME |
| CLUE-14* | 14 | 幕後黑手 | 所有線索都指向一個「幕後黑手」 | 最終 | 所有人 | FINAL |

> `CLUE-11*~CLUE-14*` 為關鍵線索，影響 `t` 真相分權重（見 `計分公式.md`）。

---

## 2) 線索收集機制

### 2.1 固定線索（必得）

- **觸發條件**：時刻改寫成立（達成目標情緒/屬性閾值）
- **產出規則**：每幕成功固定產出 1 條線索（不可重複刷）
- **存儲位置**：`/users/{userId}/clues/{clueId}`

### 2.2 額外線索（可選）

- **觸發條件**：輪次內觸發 NPC **慌張/崩潰**（任何 NPC）
- **產出規則**：額外解鎖「旁白/細節」線索（不一定指向真兇，但會推進推理板）
- **上限**：最多計入 6 條（見 `計分公式.md`）

### 2.3 線索收集流程

```
1. 時刻改寫成立
   ↓
2. 系統檢查：是否已獲得該幕固定線索？
   ├─ 是 → 不重複產出
   └─ 否 → 產出固定線索（clueId）
   ↓
3. 系統檢查：是否觸發額外線索條件？
   ├─ 是 → 產出額外線索（bonus）
   └─ 否 → 跳過
   ↓
4. 更新線索簿（UI 顯示）
   ↓
5. 毒舌系統插話（惡意解讀，見 `介面字串表.md`）
```

---

## 3) 線索簿 UI 設計

### 3.1 線索簿頁面結構

```
┌─────────────────────────────────┐
│  線索簿                          │
├─────────────────────────────────┤
│  已收集：{count}/14              │
│  關鍵線索：{keyCount}/4          │
├─────────────────────────────────┤
│  [職場] (8)                      │
│  ✓ CLUE-01 過度熱情              │
│  ✓ CLUE-02 稱讚試探              │
│  ⬜ CLUE-06 閃爍眼神              │
│  ...                             │
├─────────────────────────────────┤
│  [辦公室霸凌延伸] (5)                      │
│  ✓ CLUE-04 發送訊息              │
│  ⬜ CLUE-05 閃爍眼神              │
│  ...                             │
├─────────────────────────────────┤
│  [自我] (1)                      │
│  ⬜ CLUE-14 幕後黑手              │
└─────────────────────────────────┘
```

### 3.2 線索詳情頁面

```
┌─────────────────┐
│  CLUE-07         │
│  害怕眼神        │
├─────────────────┤
│  來源：時刻 7    │
│  被推卸責任      │
│  2019/09/10      │
├─────────────────┤
│  描述：          │
│  同事A在默認責任 │
│  的時候，眼神有  │
│  些閃爍，似乎   │
│  在害怕什麼。    │
├─────────────────┤
│  相關 NPC：      │
│  • 同事A         │
├─────────────────┤
│  標籤：          │
│  #被威脅 #害怕   │
├─────────────────┤
│  [關聯分析]      │
└─────────────────┘
```

### 3.3 關聯分析功能

- **功能**：把兩條線索放在一起，看它們在說什麼
- **UI**：拖拽兩條線索到「關聯分析區」
- **輸出**：系統提示關聯性（例如：「兩條線索都指向『被威脅』」）

---

## 4) 線索與真相推理

### 4.1 推理邏輯（規則化）

**輸入**：已收集的線索列表

**分析步驟**：

1. **統計標籤頻率**
   - `THREATENED` 出現次數
   - `REPORT` 出現次數
   - `COLLUSION` 出現次數
   - ...

2. **識別模式**
   - 若 `THREATENED` >= 3 → 指向「幕後黑手」模式
   - 若 `REPORT` >= 2 → 指向「通報系統」模式
   - 若 `COLLUSION` >= 2 → 指向「串通」模式

3. **推斷結論**
   - 所有嫌疑人（同事A、主管、同事C）都「被威脅」
   - 真正的兇手可能是一個「幕後黑手」，操縱所有人

### 4.2 真相推理 UI（結局前）

```
┌─────────────────────────────────┐
│  真相推理                        │
├─────────────────────────────────┤
│  已收集線索：{count}/14          │
│  關鍵線索：{keyCount}/4           │
├─────────────────────────────────┤
│  分析結果：                      │
│  • 同事A：被威脅                 │
│  • 主管：被威脅                  │
│  • 同事C：被威脅                 │
│  → 指向「幕後黑手」              │
├─────────────────────────────────┤
│  [揭露真相] [繼續收集]           │
└─────────────────────────────────┘
```

### 4.3 真相揭露流程

**觸發條件**：完成所有 14 個時刻

**流程**：

1. **行為改變評估**（核心）
   - 評估是否成功改變自己的行為模式
   - 影響：決定是否有能力改變命運

2. **真相推理**（副線）
   - 分析所有收集的線索
   - 推斷出真正的兇手
   - 玩家可以選擇：
     - 相信某個嫌疑人（可能錯誤）
     - 懷疑所有人（可能找不到真相）
     - 找出真正的兇手（正確）

3. **結局選擇**
   - 復仇 / 原諒 / 揭露
   - 限制：其他角色沒有回到過去，你無法用「他們記得未來」作為對質武器

---

## 5) 線索在前情提要中的呈現

### 5.1 前情提要中的線索埋設

- **每個片段包含關鍵線索**（見 `前情提要腳本.md`）
- **線索類型**：
  - **手上拿的東西**：具體物品，與後續挑戰連貫
  - **說的話**：對話框顯示關鍵對話
  - **背景的字**：日期、地點等關鍵信息
  - **關鍵字**：半透明標籤，提示線索含義

### 5.2 認真觀看的優勢

- **認真觀看前情提要的玩家**：能在每個片段中發現關鍵線索
- **這些線索會在後續挑戰中成為優勢**：幫助玩家更快找出真相
- **線索類型分為**：隱藏線索、關鍵線索、累積結果、最終線索

---

## 6) 線索系統的技術實現

### 6.1 數據存儲（Firestore）

```typescript
// /users/{userId}/clues/{clueId}
interface UserClue {
  clueId: string;
  userId: string;
  momentId: number;
  discoveredAt: Timestamp;
  isKeyClue: boolean;
  metadata: {
    relatedNpcs: string[];
    tags: string[];
  };
}
```

### 6.2 API 端點

```typescript
// 獲取線索列表
GET /api/clues?userId={userId}

// 獲取線索詳情
GET /api/clues/{clueId}?userId={userId}

// 關聯分析
POST /api/clues/analyze
Body: { clueIds: [string, string] }
Response: { relation: string, hint: string }
```

### 6.3 前端實現

- **線索簿組件**：`ClueBoard.tsx`
- **線索詳情組件**：`ClueDetail.tsx`
- **關聯分析組件**：`ClueAnalysis.tsx`
- **狀態管理**：`clueStore.ts`（Zustand）

---

## 7) 線索系統的遊戲體驗設計

### 7.1 線索收集的成就感

- **視覺反饋**：獲得線索時顯示動畫
- **音效反饋**：獲得線索時播放音效
- **毒舌插話**：獲得線索時毒舌系統惡意解讀（見 `介面字串表.md`）

### 7.2 線索分析的引導

- **關聯提示**：當收集到相關線索時，系統提示「這兩條線索有關聯」
- **推理引導**：當收集到關鍵線索時，系統提示「這可能是關鍵證據」
- **真相提示**：當收集到足夠線索時，系統提示「你可以開始推理真相了」

### 7.3 線索系統的沉浸感

- **禁用詞規範**：線索描述不使用「遊戲/關卡/玩家」等出戲詞
- **第一人稱視角**：線索描述使用「你」的視角
- **情感投入**：線索描述帶有情感色彩，讓玩家感受到「發現真相」的滿足

---

## 8) 線索系統的測試用例

### 8.1 線索收集測試

- [ ] 時刻改寫成立時，固定線索正確產出
- [ ] 重複完成同一時刻時，不重複產出固定線索
- [ ] NPC 慌張/崩潰時，額外線索正確產出
- [ ] 額外線索上限正確（最多 6 條）

### 8.2 線索分析測試

- [ ] 關聯分析功能正確
- [ ] 真相推理邏輯正確
- [ ] 結局選擇正確觸發

### 8.3 線索 UI 測試

- [ ] 線索簿正確顯示已收集線索
- [ ] 線索詳情頁面正確顯示
- [ ] 關聯分析 UI 正確運作

---

## 總結

線索系統的完整實現包括：

1. **線索數據結構**：14 個固定線索的完整定義
2. **收集機制**：固定線索 + 額外線索的產出規則
3. **UI 設計**：線索簿、詳情頁、關聯分析
4. **推理系統**：規則化的真相推理邏輯
5. **技術實現**：Firestore 存儲、API 端點、前端組件
6. **遊戲體驗**：成就感、引導、沉浸感

建議按照階段逐步實施，先實現基礎的線索收集和顯示，再逐步完善推理系統。

