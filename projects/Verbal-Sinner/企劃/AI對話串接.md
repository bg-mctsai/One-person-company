# AI 對話串接（即時 NPC 回覆）

> 目標：中途時刻與結局都能「即時串接角色 AI」生成 NPC 回覆（OpenAI / Gemini 皆可），同時保留你既有的毒舌系統文案與規則。

---

## 1) 架構（最少可跑版本）

- **前端**：呼叫兩個 Firebase callable functions：
  - `parsePlayerInput`：解析玩家輸入文字為策略類型 + tags
  - `generateNpcReply`：生成 NPC 回覆
- **後端**：Firebase Functions 代你呼叫 OpenAI / Gemini（API key 只放在 functions）
- **回傳**：統一 JSON，前端再接：
  - `parsePlayerInput` 回傳：`optionType`, `tags`, `confidence`, `parsedIntent`
  - `generateNpcReply` 回傳：NPC 回覆文字、情緒提示、notes

---

## 2) Firebase Functions：`parsePlayerInput`（新增）

### 位置

- `verbal-sinner-game/functions/index.js`

### 輸入（data）

```json
{
  "provider": "openai",
  "model": "gpt-4o-mini",
  "playerText": "這不是我造成的。我可以把時間線和文件攤開。",
  "momentId": 7,
  "roundId": 1,
  "availableOptionTypes": ["積極對抗", "溫和堅持", "情感訴求", "順從消極"],
  "tongueHints": [
    {
      "text": "我先把時間線講清楚...",
      "optionType": "溫和堅持",
      "tags": ["證據"]
    },
    {
      "text": "這不是我造成的。請你先看我這份交付紀錄。",
      "optionType": "積極對抗",
      "tags": ["證據", "界線"]
    }
  ]
}
```

### 輸出（return）

```json
{
  "optionType": "積極對抗",
  "tags": ["證據"],
  "confidence": 0.85,
  "parsedIntent": "玩家提出證據反駁，態度強硬",
  "fallbackHintId": null
}
```

> 如果解析失敗或信心度過低（< 0.6），可回傳 `fallbackHintId` 指向最接近的毒舌提示選項。

---

## 3) Firebase Functions：`generateNpcReply`

### 位置

- `verbal-sinner-game/functions/index.js`

### 輸入（data）

```json
{
  "provider": "openai",
  "model": "gpt-4o-mini",
  "momentTitle": "被推卸責任",
  "npcName": "主管",
  "npcRole": "主管（結果導向）",
  "npcVoice": "冷、短句、帶壓迫感",
  "npcEmotion": "冷漠",
  "npcTraits": "偏程序、怕麻煩、對證據敏感",
  "playerLine": "這不是我造成的。我可以把時間線和文件攤開。",
  "history": [
    "主管：這次延誤，你負責的部分怎麼解釋？",
    "你：我先把時間線講清楚..."
  ],
  "constraints": "npc_reply 只能 1-2 句；不得出現「遊戲/關卡/玩家/挑戰/UI」"
}
```

### 輸出（return）

```json
{
  "provider": "openai",
  "model": "gpt-4o-mini",
  "npc_reply": "…給我看。你最好有東西能證明。",
  "npc_emotion_hint": "震驚",
  "notes": "玩家帶證據，NPC警戒上升但被迫接受對質",
  "raw": null
}
```

---

## 4) 金鑰與設定（不要放前端）

## 3.1 強烈建議：App Check（匿名大量玩家必備）

> 你的前端不登入沒問題，但**一定要有 App Check**，不然任何人拿到你的 callable 名稱就能刷爆你（你付 AI 錢）。

- Functions 端已可設定 `enforceAppCheck: true`
- Web 端可用 reCAPTCHA v3 / Enterprise 作為 App Check provider

### OpenAI

- 環境變數：`OPENAI_API_KEY`
- 或 Firebase functions config：`functions.config().openai.key`

### Gemini

- 環境變數：`GEMINI_API_KEY`
- 或 Firebase functions config：`functions.config().gemini.key`

> 建議：先用環境變數（部署平台/CI 管）；或用 firebase config（本地/早期方便）。

## 3.2（可選）匿名登入：不打擾體驗，但拿得到 uid 做限流

> 你說「前端不用登入」通常是指 **不用帳號/不用登入頁**。  
> 但 Firebase **Anonymous Auth** 可以在背景自動給每個裝置一個 uid（玩家完全無感），對你做：

- 每 uid 限流 / 計費 / 封鎖
- 防止同一人狂刷（比只看 IP 穩）

---

## 5) 跟「毒舌系統」怎麼共存？

- **NPC 回覆**：交給 AI（即時、符合人味）
- **毒舌系統**：仍走你既有 `介面字串表.md` 的規則（進場/選項前/成立/線索/失手/結算），由前端或規則引擎決定是否插話
- **做法**：
  - AI 只回 `npc_reply`（NPC 說的話）
  - 毒舌系統的話照既有台詞池抽（不要叫 AI 生成毒舌，避免風格漂移）

---

## 6) 下一步（你想要的「更黑、更準」）

- **結構化輸出**：要求 AI 回傳 `emotion_delta` / `suspicion_hint` 之類欄位，讓屬性更新更穩
- **多模型策略**：
  - 平常：Gemini 1.5 Flash（快、便宜）
  - 關鍵幕：OpenAI（更穩、更會演）
- **防噴**：加上輸出長度、禁詞表、重試一次（fallback）

---

## 7) 成本控管：把「多次嘗試」變成可控的代價

你說「復活一定要刷廣告」**確實會降低總會話數**，但它不會自動限制「每個玩家在對話中呼叫 AI 的次數」。  
要真的控成本，建議做成 **三層控管**（從硬到軟）：

### 6.1 硬防線（必做）

- **App Check**：擋外部腳本濫用（Functions 已 `enforceAppCheck: true`）
- **token 化（最直覺、最好控成本）**：用「訊息門檻」+「通行證次數」去控制“嘗試次數”，而不是賣一堆商品。  
  - **免訊息通行證**：N 次（每次可抵扣一次「入幕」或一次「回到 5 分鐘前」）  
  - **逼他說清楚（延長句數）**：本幕句數用完時，可 **+5 句**（每幕最多一次）
  - **金手指提示**：你主動詢問毒舌系統「這個人到底在想什麼」的偷看能力（每幕最多一次；每次必須付代價）

#### 金手指提示輸出限制（硬規則）

> 目標：讓玩家有「偷看」的爽感，但**不提供解答**，不破壞推理與成就感。

- **只給方向**：指出「該關注的面向」或「你下一句該站的位置」（界線/證據/後果/情緒節點）
- **禁止給答案**（提示不會出現）：
  - 直接告訴你「選哪個選項/第幾個選項」
  - 直接告訴你「真兇是誰 / 誰在說謊」
  - 直接給「具體證據內容」或「完整時間線解答」
  - 任何破案式的結論句
- **形式**：1 句（最多 2 句），用毒舌系統口吻（判決/解剖），但仍只給方向

### 6.2 訊息門檻（你現在要的規則）

不要把每一句 NPC 回覆都卡廣告，體驗會裂。比較好的做法是：

- **入幕**：每次走進一幕 → 看一次訊息（或消耗 1 次免訊息通行證）
- **回溯**：每次回到 5 分鐘前 → 看一次訊息（或消耗 1 次免訊息通行證）
- **延長句數**：本幕句數用完 → 看一次訊息即可「逼他說清楚（+5 句）」（每幕最多一次；也可付費）
- **金手指提示**：你主動詢問毒舌系統 → 看一次訊息即可拿 1 次提示（每幕最多一次；也可付費）

> 這樣廣告同時在「生存（復活/再試）」與「表現（更像真人的 NPC）」兩條線上變現。

### 6.3 軟控（省錢但還像人）

- **模型分流**：
  - 一般句：Gemini Flash（便宜/快）
  - 關鍵句（第 11–14、揭露/復仇/走開前）：OpenAI（穩/演技）
- **快取**：同一幕同一個「玩家選項」常見可快取（避免重複付費）
- **熔斷**：AI API 失敗或成本過高 → 立即切回模板（維持可玩）

---

## 8) 玩家付費會很難嗎？（不難，但要先決定「買什麼」與「綁到誰」）

### 7.1 付費商品（少 SKU、對體驗友善）

- **免訊息通行證**：一次性或可重複購買（N 次）
- **逼他說清楚（+5 句）**：可做成「每幕一次」的單次購買（或包含在通行證內）
- （可選）**內容解鎖**：額外片段/支線/結局補完（不影響公平性）
 - **金手指提示券**：買「不用看訊息也能偷看一次」的提示券（專門賣爽感）

### 7.1.1 建議你先上線的 2 個 SKU（最能賺、最不破壞體驗）

- **免訊息通行證（主力）**：不想被打斷的人買  
  - 建議：**NT$60** → 免訊息 30 次（抵扣入幕/回溯）  
  - 建議：**NT$120** → 免訊息 80 次
- **逼他說清楚（+5 句）**（次要，但轉換好）：卡關當下才出現  
  - 建議：**NT$30** → 本幕 +5 句（每幕最多一次）

> 金手指提示要賣：它是「偷看」的爽感，不是教學。每次提示預設要看訊息；付費就是買「不用看訊息」的提示券。

### 7.1.2 金手指提示券（建議定價 / 少 SKU）

- 小包：**NT$30** → 提示券 3 次
- 中包：**NT$60** → 提示券 8 次
- 大包：**NT$120** → 提示券 20 次

> 建議：提示券只在玩家打開「金手指」時出現，不做主選單商店，避免破壞沉浸。

---

## 9) 金手指（提示）要「明確功能」，不要 AI 自己發揮

你要的金手指核心是兩件事（且可完全規則化）：

1. **角色狀態**：回傳當下「表層情緒」與「正/負/中性」  
2. **指定角色**：你可以選擇「這一幕畫面上出現的任一角色」來偷聽心聲

### 8.1 角色狀態（規則化）

- **情緒**：直接使用 `出場角色.md` 的「屬性 → 表層情緒」映射（冷漠/困惑/震驚/憤怒/慌張/崩潰/好感/欣賞/尊重/愧疚/認同）
- **正/負/中性**：由情緒映射到 polarity：
  - 正面：好感 / 欣賞 / 尊重 / 愧疚 / 認同
  - 負面：憤怒 / 震驚 / 慌張 / 崩潰
  - 中性：冷漠 / 困惑

> 這裡不需要 AI；只要你有 NPC 屬性快照就能算出結果。

### 8.2 「聽到心聲」也要可控：模板 + 主導屬性（不給答案）

金手指回傳 1 句「方向型心聲」，來源不是 AI 即興，而是：

- **主導屬性**（取當下最高/最關鍵的一項）：警戒 / 恐懼 / 罪惡感 / 壓力 / 信任 / 尊重
- **情境種子**（每幕固定 1 個 seed）：由 `金手指提示庫.md` 提供（來源對齊 `完整故事情節.md` 的「隱藏線索/關鍵線索」）

然後用模板產出「方向」：
- 警戒高：他在試探你底線／你越解釋越危險
- 恐懼高：他怕曝光／怕被牽連（但不說出誰在威脅他）
- 罪惡感高：他立場在動搖／下一句要逼他承擔
- 壓力高：他急著結束話題／會轉移
- 信任高：他願意聽，但你必須穩
- 尊重高：他只吃證據/界線

#### 禁止事項（硬規則）

- 不告訴你「選哪個選項/第幾個選項」
- 不直接點名「真兇是誰/誰在說謊」
- 不提供「完整解答」，只給方向

### 8.3 建議輸出欄位（方便前端）

- `emotion`: 表層情緒（字串）
- `polarity`: 正面/負面/中性
- `whisper`: 1 句方向型心聲（字串）
- `tag`: 試探/拖延/轉移/掩飾/求和/威脅（可選）


### 8.2 Web（你現在 Firebase Hosting/React）最短路徑：Stripe

最少要做的後端元件：

- **建立 Checkout**：前端點「購買」→ 後端建立 Stripe Checkout Session → 前端跳轉付款
- **Webhook**：Stripe 付款成功事件 → 後端寫入 entitlement（例如：`no_ads=true`、`ai_quota=+100`）
- **查 entitlement**：前端呼叫後端拿目前權益，控制是否要看廣告/是否能用 AI

### 8.3 「前端不登入」的前提下，付費要怎麼綁？

純匿名（完全沒有 uid）會讓你很難：

- 退款/補發權益
- 換機/清快取後找回購買
- 擋同一人重複刷

所以實務上我會建議：**不做登入頁，但用 Anonymous Auth 背景給 uid**（玩家無感）。  
這樣你就能把「付款權益」綁到 uid（可跨裝置就再加 email/linking）。
