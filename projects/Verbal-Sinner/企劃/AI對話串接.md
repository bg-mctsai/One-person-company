# AI 對話串接（即時 NPC 回覆）

> 目標：中途時刻與結局都能「即時串接角色 AI」生成 NPC 回覆（OpenAI / Gemini 皆可），同時保留你既有的毒舌系統文案與規則。

---

## 1) 架構（最少可跑版本）

- **前端**：呼叫兩個 Firebase callable functions：
  - `parsePlayerInput`：解析玩家輸入文字為策略類型 + tags
  - `generateNpcReply`：生成 NPC 回覆
- **後端**：Firebase Functions 代你呼叫 OpenAI / Gemini（API key 只放在 functions）
- **回傳**：統一 JSON，前端再接：
  - `parsePlayerInput` 回傳：`optionType`, `tags`, `confidence`, `parsedIntent`
  - `generateNpcReply` 回傳：NPC 回覆文字、情緒提示、notes

---

## 2) Firebase Functions：`parsePlayerInput`（新增）

### 位置

- `verbal-sinner-game/functions/index.js`

### 輸入（data）

```json
{
  "provider": "openai",
  "model": "gpt-4o-mini",
  "playerText": "這不是我造成的。我可以把時間線和文件攤開。",
  "momentId": 7,
  "roundId": 1,
  "availableOptionTypes": ["積極對抗", "溫和堅持", "情感訴求", "順從消極"],
  "tongueHints": [
    {
      "text": "我先把時間線講清楚...",
      "optionType": "溫和堅持",
      "tags": ["證據"]
    },
    {
      "text": "這不是我造成的。請你先看我這份交付紀錄。",
      "optionType": "積極對抗",
      "tags": ["證據", "界線"]
    }
  ]
}
```

### 輸出（return）

```json
{
  "optionType": "積極對抗",
  "tags": ["證據"],
  "confidence": 0.85,
  "parsedIntent": "玩家提出證據反駁，態度強硬",
  "fallbackHintId": null
}
```

> 如果解析失敗或信心度過低（< 0.6），可回傳 `fallbackHintId` 指向最接近的毒舌提示選項。

---

## 3) Firebase Functions：`generateNpcReply`

### 位置

- `verbal-sinner-game/functions/index.js`

### 輸入（data）

```json
{
  "provider": "openai",
  "model": "gpt-4o-mini",
  "momentTitle": "被推卸責任",
  "npcName": "王明哲",
  "npcRole": "王明哲（結果導向）",
  "npcVoice": "冷、短句、帶壓迫感",
  "npcEmotion": "冷漠",
  "npcTraits": "偏程序、怕麻煩、對證據敏感",
  "playerLine": "這不是我造成的。我可以把時間線和文件攤開。",
  "history": [
    "王明哲：這次延誤，你負責的部分怎麼解釋？",
    "你：我先把時間線講清楚..."
  ],
  "constraints": "npc_reply 只能 1-2 句；不得出現「遊戲/關卡/玩家/挑戰/UI」"
}
```

### 輸出（return）

```json
{
  "provider": "openai",
  "model": "gpt-4o-mini",
  "npc_reply": "…給我看。你最好有東西能證明。",
  "npc_emotion_hint": "震驚",
  "notes": "玩家帶證據，NPC警戒上升但被迫接受對質",
  "raw": null
}
```

---

## 4) 金鑰與設定（不要放前端）

## 3.1 強烈建議：App Check（匿名大量玩家必備）

> 你的前端不登入沒問題，但**一定要有 App Check**，不然任何人拿到你的 callable 名稱就能刷爆你（你付 AI 錢）。

- Functions 端已可設定 `enforceAppCheck: true`
- Web 端可用 reCAPTCHA v3 / Enterprise 作為 App Check provider

### OpenAI

- 環境變數：`OPENAI_API_KEY`
- 或 Firebase functions config：`functions.config().openai.key`

### Gemini

- 環境變數：`GEMINI_API_KEY`
- 或 Firebase functions config：`functions.config().gemini.key`

> 建議：先用環境變數（部署平台/CI 管）；或用 firebase config（本地/早期方便）。

## 3.2（可選）匿名登入：不打擾體驗，但拿得到 uid 做限流

> 你說「前端不用登入」通常是指 **不用帳號/不用登入頁**。  
> 但 Firebase **Anonymous Auth** 可以在背景自動給每個裝置一個 uid（玩家完全無感），對你做：

- 每 uid 限流 / 計費 / 封鎖
- 防止同一人狂刷（比只看 IP 穩）

---

## 5) 跟「毒舌系統」怎麼共存？

- **NPC 回覆**：交給 AI（即時、符合人味）
- **毒舌系統**：仍走你既有 `介面字串表.md` 的規則（進場/選項前/成立/線索/失手/結算），由前端或規則引擎決定是否插話
- **做法**：
  - AI 只回 `npc_reply`（NPC 說的話）
  - 毒舌系統的話照既有台詞池抽（不要叫 AI 生成毒舌，避免風格漂移）

---

## 6) 下一步（你想要的「更黑、更準」）

- **結構化輸出**：要求 AI 回傳 `emotion_delta` / `suspicion_hint` 之類欄位，讓屬性更新更穩
- **多模型策略**：
  - 平常：Gemini 1.5 Flash（快、便宜）
  - 關鍵幕：OpenAI（更穩、更會演）
- **防噴**：加上輸出長度、禁詞表、重試一次（fallback）

---

## 7) 成本控管：把「多次嘗試」變成可控的代價

你說「復活一定要刷廣告」**確實會降低總會話數**，但它不會自動限制「每個玩家在對話中呼叫 AI 的次數」。  
要真的控成本，建議做成 **三層控管**（從硬到軟）：

### 6.1 硬防線（必做）

- **App Check**：擋外部腳本濫用（Functions 已 `enforceAppCheck: true`）
- **token 化（最直覺、最好控成本）**：用「訊息門檻」+「通行證次數」去控制“嘗試次數”，而不是賣一堆商品。  
  - **免訊息通行證**：N 次（每次可抵扣一次「入幕」或一次「回到 5 分鐘前」）  
  - **逼他說清楚（延長句數）**：本幕句數用完時，可 **+5 句**（每幕最多一次）
  - **金手指提示**：你主動詢問毒舌系統「這個人到底在想什麼」的偷看能力（每幕最多一次；每次必須付代價）

#### 金手指提示輸出限制（硬規則）

> 目標：讓玩家有「偷看」的爽感，但**不提供解答**，不破壞推理與成就感。

- **只給方向**：指出「該關注的面向」或「你下一句該站的位置」（界線/證據/後果/情緒節點）
- **禁止給答案**（提示不會出現）：
  - 直接告訴你「選哪個選項/第幾個選項」
  - 直接告訴你「推動者是誰 / 誰在丟鍋 / 誰在說謊」
  - 直接給「具體證據內容」或「完整時間線解答」
  - 任何破案式的結論句
- **形式**：1 句（最多 2 句），用毒舌系統口吻（判決/解剖），但仍只給方向

### 6.2 訊息門檻（你現在要的規則）

不要把每一句 NPC 回覆都卡廣告，體驗會裂。比較好的做法是：

- **入幕**：每次走進一幕 → 看一次訊息（或消耗 1 次免訊息通行證）
- **回溯**：每次回到 5 分鐘前 → 看一次訊息（或消耗 1 次免訊息通行證）
- **延長句數**：本幕句數用完 → 看一次訊息即可「逼他說清楚（+5 句）」（每幕最多一次；也可付費）
- **金手指提示**：你主動詢問毒舌系統 → 看一次訊息即可拿 1 次提示（每幕最多一次；也可付費）

> 這樣廣告同時在「生存（復活/再試）」與「表現（更像真人的 NPC）」兩條線上變現。

### 6.3 軟控（省錢但還像人）

- **模型分流**：
  - 一般句：Gemini Flash（便宜/快）
  - 關鍵句（第 11–14、揭露/離開/和解前）：OpenAI（穩/演技）
- **快取**：同一幕同一個「玩家選項」常見可快取（避免重複付費）
- **熔斷**：AI API 失敗或成本過高 → 立即切回模板（維持可玩）

### 6.4 AI 觸發矩陣（模板 vs AI / 什麼時候出聲 / 為什麼要出聲）

> 目標：把 AI 只用在「互動必需且有價值」的點；其餘全部腳本化，確保品質穩、成本可控。

#### A. 一句總結（決策原則）

- **固定鋪陳 / 關鍵劇情**：用模板（可控、穩定、好審稿）
- **玩家自由輸入後的即時回應**：用 AI（不然就不像真人）
- **群體插話/打斷/帶風向**：模板為主、AI 為輔（用 AI 做變化版本）
- **提示（金手指）**：模板（只給方向，風格一致、不劇透）

#### B. 觸發表（每個「觸發點」最多幾次）

| 觸發點 | 是否用 AI | 每幕次數上限 | 目的（為什麼要 AI） | 失敗時 fallback |
|---|---|---:|---|---|
| 進場「NPC 串場」(玩家回合前) | 模板為主 / 可選 AI 變體 | 0–1 | 交代壓力來源、拉出群體氛圍；用 AI 只為了「不重複」 | 永遠可回模板 |
| 每輪：玩家自由輸入 → NPC 回覆 | ✅ AI | 3–6（視輪次上限） | 讓 NPC 真的在回你、依屬性變化（警戒/壓力/尊重）調整語氣 | 回模板「通用回覆」+ 建議改用提示選項 |
| 玩家講得太含糊/太長/太討好 → NPC 追問具體化 | ✅ AI（或模板追問） | 1 | 把玩家訓練拉回「事實/請求/界線」格式；避免空泛對話 | 固定追問模板（不靠 AI） |
| 多人場景：何婉柔插話帶風向 | 可選 AI | 0–1 | 做出「每次都不一樣的風向話術」，提升重玩性與壓迫感 | 固定風向模板庫 |
| 多人場景：王明哲/林予衡 打斷與流程話術 | 模板為主 | 0–1 | 這類句子要穩、要像模板公文；AI 容易漂風格 | 固定流程話術模板 |
| 改寫成立後的 NPC 最後一句 | 可選 AI | 0–1 | 給「冷讚/退一步/改口」的變化，讓勝利有重量 | 固定冷讚模板 |
| 失手後毒舌插刀 | 不建議 AI | 0 | 毒舌風格要一致且可控（避免漂） | `介面字串表.md` |
| 金手指提示（毒舌真話） | 不建議 AI | 0 | 只給方向、不劇透；可完全規則化（模板 + 種子） | `金手指提示庫.md` |
| 結局前「可追責陳述」整理（可選） | ✅ AI（推薦） | 1 | 把玩家寫的內容整理成更清楚、可存證的版本（不改意思） | 直接回傳玩家原文 + 2 條模板建議 |

#### C. 每幕推薦「AI 配額」（對齊 10 關設計）

> 這不是限制玩家體驗，是幫你估算成本與做熔斷策略。

- **低壓幕（1–3）**：AI 回覆 2–3 次即可；其餘用模板串場（教學感、便宜）
- **升壓幕（4–6）**：AI 回覆 3–5 次；允許 1 次「追問具體化」
- **高壓幕（7–9）**：AI 回覆 4–6 次；可加 1 次「群體插話 AI 變體」（只為不重複）
- **收束幕（10）**：AI 回覆 2–4 次；不要用 AI 毒舌（用固定金句更有力）

#### D. 用 AI 的「具體目的」要能回到玩法

- **讓 NPC 像真人**：同一句玩家輸入，不同屬性快照，回覆要不同（警戒高就短硬、尊重高就願意談）
- **逼玩家變具體**：把玩家從「我覺得/我很努力」拉回「事實/範圍/請求/後果」
- **群體壓迫的變化**：何婉柔的風向話術每次不完全相同，玩家才不覺得背台詞
- **提高重玩性但不破壞推理**：變的是「說法」，不變的是「機制方向」

#### E. Interrupt Event（打斷事件）機制：怎麼做出「被打斷」但不打斷打字體驗

> 核心原則：**不要在玩家打字中插話**（會干擾、也難自然）。  
> 改用「玩家送出後 → 系統插入 1–2 句打斷 → 玩家再回」來做壓迫感。

##### E1. 打斷事件長什麼樣（前端顯示）

- 顯示方式：像普通對話一樣出現，但標記為 `interrupt`（可加 UI 樣式：更快打字速度/更短停頓）
- 出現時機：**玩家送出後**、進入下一次玩家回合前
- **不扣玩家句數**（避免玩家覺得被陰）

##### E2. 什麼時候觸發（觸發條件）

打斷事件不是每輪都發生，只在「需要施壓或拉回格式」時出現：

- **玩家輸入太長（解釋型）**：例如 > 120–160 字（可按語言調整）
  - 目的：王明哲/林予衡 打斷你「別解釋人生，講重點」
- **玩家輸入太含糊/沒有請求**：缺少具體請求/下一步（可用 `parsePlayerInput` 的 `tags` 與 `parsedIntent` 判）
  - 目的：逼你補「你要對方做什麼」
- **玩家情緒化升溫**：`tags` 含「指控/威脅/人身攻擊/情緒爆炸」
  - 目的：群體反噬（何婉柔放大、王明哲制止、林予衡鎖程序）
- **玩家帶證據（高價值回合）**：`tags` 含「證據/時間線/存證」
  - 目的：對方慌張、急著截斷（更真實），或逼你把證據「說成可追責句子」
- **高壓幕（7–9）專屬**：每幕可允許 1 次「群體插話」變體（提高壓迫感與重玩性）

##### E3. 誰來打斷（角色選擇規則）

依情境選擇「最符合機制」的打斷者：

- **王明哲**：打斷你的長篇解釋、逼你承諾、要求「結論/時程」
- **林予衡**：把話鎖回「流程/紀錄/可受理範圍」
- **何婉柔**：把你的話剪成風向（「你看他又在解釋」「他情緒又來了」）
- **許子維**：假客觀切割（「我不是針對你」）或補刀（把責任推回你）

##### E4. 後端回傳格式（建議欄位）

> 建議把打斷事件跟 `generateNpcReply` 一起回傳，前端就能在同一輪渲染。

```json
{
  "provider": "openai",
  "model": "gpt-4o-mini",
  "npc_reply": "…給我看。你最好有東西能證明。",
  "npc_emotion_hint": "震驚",
  "interrupt": {
    "enabled": true,
    "speaker": "林予衡",
    "style": "流程鎖死",
    "line": "請回到紀錄。你現在講的是感受，不是事實。",
    "consumePlayerTurn": false,
    "effects": {
      "npc_pressure_delta": +5,
      "npc_vigilance_delta": +8
    }
  }
}
```

##### E5. 模板 vs AI：怎麼控成本

- **王明哲/林予衡 的打斷**：優先模板（風格穩、像制度話術）
- **何婉柔 的打斷**：可用 AI 產生變體（只為不重複），但每幕最多 1 次
- **熔斷**：AI 失敗/超時 → 打斷事件永遠可回模板（不影響可玩）

##### E6. 對齊 10 關的使用建議（情境不會崩）

- **第 1–3 關（低壓）**：通常不需要打斷（讓玩家學會「先思考/設界線」）
- **第 4–6 關（升壓）**：可偶爾打斷一次，提醒「別道歉、講分工/條件」
- **第 7–9 關（高壓）**：每幕允許 1 次打斷事件，做出「被圍住」感
- **第 10 關（收束）**：不建議用外部打斷；只用「過去的自己 + 毒舌系統」的內心插話（你已在 `挑戰系統.md` 寫好）

---

## 6.5 線索抽取（AI 產「情報卡」而非證物圖）

> 核心立場：你的線索多為「人際/情緒/界線/權力動態」→ **不需要做證物圖**。  
> 我們要的是：回合結束後，從 transcript 抽出 1 句「可核對摘錄」+ 1 句「規則化依據」→ 形成 `EvidenceCard(payload.type=insight)`。

### 6.5.1 觸發點（什麼時候叫 AI）

- **每幕通關結算**：固定抽取 1 次（對應該幕發放的 `clueIds`）
- **（可選）玩家觸發額外線索**：例如 NPC 慌張/崩潰時（見 `線索系統實現.md` 2.2）

> 不要每回合都抽，會貴、也會讓線索變噪音。

### 6.5.2 建議新增 Callable：`extractInsightClue`（或併入規則引擎）

**輸入（data）**

```json
{
  "provider": "openai",
  "model": "gpt-4o-mini",
  "momentId": 7,
  "clueId": "CLUE-11",
  "transcript": [
    "林予衡：請回到流程。你現在講的是感受，不是事實。",
    "你：我可以把時間線和文件攤開。",
    "王明哲：…給我看。你最好有東西能證明。"
  ],
  "constraints": {
    "outputSchemaRef": "projects/Verbal-Sinner/企劃/給工程/ai-insight-output.schema.json",
    "noNewFacts": true,
    "excerptMustBeFromTranscript": true
  }
}
```

**輸出（return）**（必須符合 schema）

```json
{
  "clueId": "CLUE-11",
  "speaker": "林予衡",
  "insightTags": ["institutionalRhetoric", "power", "evidence"],
  "excerpt": "「請回到流程。你現在講的是感受，不是事實。」",
  "rationale": "用制度語言鎖死討論框架，把你從『主張』拉回『可受理範圍』，逼你只剩證據能說話。",
  "confidence": 0.78
}
```

### 6.5.3 硬規則（防飄 / 防補劇情）

- **只允許輸出 schema 欄位**（不得多欄位）
- **excerpt 必須是 transcript 原句**（逐字一致）
- **rationale 必須是規則化判斷**（禁止新增事件、禁止旁白、禁止補時間線）
- 若 `confidence < 0.6` 或驗證失敗 → **fallback**：用 `給工程/evidence-cards.sample.json` 的對應卡片（或固定模板）

### 6.5.4 成本控管（最省但穩）

- 每幕最多抽 1 次（通關時）
- 先用便宜模型；關鍵幕（7–10）才升級
- 相同 `momentId+clueId+transcriptHash` 可以快取（避免重試重付）

## 8) 玩家付費會很難嗎？（不難，但要先決定「買什麼」與「綁到誰」）

### 7.1 付費商品（少 SKU、對體驗友善）

- **免訊息通行證**：一次性或可重複購買（N 次）
- **逼他說清楚（+5 句）**：可做成「每幕一次」的單次購買（或包含在通行證內）
- （可選）**內容解鎖**：額外片段/支線/結局補完（不影響公平性）
 - **金手指提示券**：買「不用看訊息也能偷看一次」的提示券（專門賣爽感）

### 7.1.1 建議你先上線的 2 個 SKU（最能賺、最不破壞體驗）

- **免訊息通行證（主力）**：不想被打斷的人買  
  - 建議：**NT$60** → 免訊息 30 次（抵扣入幕/回溯）  
  - 建議：**NT$120** → 免訊息 80 次
- **逼他說清楚（+5 句）**（次要，但轉換好）：卡關當下才出現  
  - 建議：**NT$30** → 本幕 +5 句（每幕最多一次）

> 金手指提示要賣：它是「偷看」的爽感，不是教學。每次提示預設要看訊息；付費就是買「不用看訊息」的提示券。

### 7.1.2 金手指提示券（建議定價 / 少 SKU）

- 小包：**NT$30** → 提示券 3 次
- 中包：**NT$60** → 提示券 8 次
- 大包：**NT$120** → 提示券 20 次

> 建議：提示券只在玩家打開「金手指」時出現，不做主選單商店，避免破壞沉浸。

---

## 9) 金手指（提示）要「明確功能」，不要 AI 自己發揮

你要的金手指核心是兩件事（且可完全規則化）：

1. **角色狀態**：回傳當下「表層情緒」與「正/負/中性」  
2. **指定角色**：你可以選擇「這一幕畫面上出現的任一角色」來偷聽心聲

### 8.1 角色狀態（規則化）

- **情緒**：直接使用 `出場角色.md` 的「屬性 → 表層情緒」映射（冷漠/困惑/震驚/憤怒/慌張/崩潰/好感/欣賞/尊重/愧疚/認同）
- **正/負/中性**：由情緒映射到 polarity：
  - 正面：好感 / 欣賞 / 尊重 / 愧疚 / 認同
  - 負面：憤怒 / 震驚 / 慌張 / 崩潰
  - 中性：冷漠 / 困惑

> 這裡不需要 AI；只要你有 NPC 屬性快照就能算出結果。

### 8.2 「聽到心聲」也要可控：模板 + 主導屬性（不給答案）

金手指回傳 1 句「方向型心聲」，來源不是 AI 即興，而是：

- **主導屬性**（取當下最高/最關鍵的一項）：警戒 / 恐懼 / 罪惡感 / 壓力 / 信任 / 尊重
- **情境種子**（每幕固定 1 個 seed）：由 `金手指提示庫.md` 提供（來源對齊 `完整故事情節.md` 的「隱藏線索/關鍵線索」）

然後用模板產出「方向」：
- 警戒高：他在試探你底線／你越解釋越危險
- 恐懼高：他怕曝光／怕被牽連（但不說出誰在威脅他）
- 罪惡感高：他立場在動搖／下一句要逼他承擔
- 壓力高：他急著結束話題／會轉移
- 信任高：他願意聽，但你必須穩
- 尊重高：他只吃證據/界線

#### 禁止事項（硬規則）

- 不告訴你「選哪個選項/第幾個選項」
- 不直接點名「推動者是誰/誰在丟鍋/誰在說謊」
- 不提供「完整解答」，只給方向

### 8.3 建議輸出欄位（方便前端）

- `emotion`: 表層情緒（字串）
- `polarity`: 正面/負面/中性
- `whisper`: 1 句方向型心聲（字串）
- `tag`: 試探/拖延/轉移/掩飾/求和/威脅（可選）


### 8.2 Web（你現在 Firebase Hosting/React）最短路徑：Stripe

最少要做的後端元件：

- **建立 Checkout**：前端點「購買」→ 後端建立 Stripe Checkout Session → 前端跳轉付款
- **Webhook**：Stripe 付款成功事件 → 後端寫入 entitlement（例如：`no_ads=true`、`ai_quota=+100`）
- **查 entitlement**：前端呼叫後端拿目前權益，控制是否要看廣告/是否能用 AI

### 8.3 「前端不登入」的前提下，付費要怎麼綁？

純匿名（完全沒有 uid）會讓你很難：

- 退款/補發權益
- 換機/清快取後找回購買
- 擋同一人重複刷

所以實務上我會建議：**不做登入頁，但用 Anonymous Auth 背景給 uid**（玩家無感）。  
這樣你就能把「付款權益」綁到 uid（可跨裝置就再加 email/linking）。
