# 結局系統詳細設計

> 目的：定義結局的觸發條件、具體內容、呈現方式、選擇後續處理。  
> 依賴文件：`計分公式.md`（b/t/scar/rewinds）、`出場角色.md`（行為改變評估）、`線索系統實現.md`（真相推理）。

---

## 1) 結局觸發條件

### 1.1 前置條件

- **必須完成**：所有 14 個時刻改寫成立
- **必須完成**：行為改變評估（核心）
- **可選完成**：真相推理（副線，影響結局選項）

### 1.2 觸發流程

```
完成所有 14 個時刻
   ↓
行為改變評估（核心）
   ├─ 評估項目：
   │  • 設界線（期末值）
   │  • 自我價值（期末值）
   │  • 依賴（期末值，越低越好）
   │  • 情緒穩定（期末值）
   │  • 警覺（期末值）
   ↓
真相推理（副線）
   ├─ 分析所有收集的線索
   ├─ 推斷出真正的兇手
   └─ 選擇：相信某個嫌疑人 / 懷疑所有人 / 找出真正的兇手
   ↓
結局選擇
   ├─ 復仇
   ├─ 原諒
   └─ 揭露
```

---

## 2) 行為改變評估（核心）

### 2.1 評估項目與權重

| 項目 | 屬性 | 權重 | 說明 |
|------|------|------|------|
| 設界線 | B | 30% | 能不能說「不」並維持界線 |
| 自我價值 | V | 30% | 自我肯定（第 14 個時刻關鍵） |
| 不依賴 | 100-D | 20% | 不靠別人批准你存在 |
| 情緒穩定 | S | 20% | 壓力下維持理性與表達的能力 |

**計算公式**（見 `計分公式.md`）：
```
b = round(0.30B + 0.30V + 0.20S + 0.20(100-D))
```

### 2.2 評估結果分級

- **good**（80-100）：成功改變行為模式
- **mid**（55-79）：部分改變，仍有改進空間
- **bad**（0-54）：未成功改變行為模式

### 2.3 評估結果影響

- **good**：有能力改變命運，可觸發所有結局選項
- **mid**：部分能力，可觸發部分結局選項
- **bad**：無能力改變命運，只能觸發悲劇結局

---

## 3) 真相推理（副線）

### 3.1 推理輸入

- **已收集線索**：`clues_fixed`（0-14）
- **關鍵線索**：`clues_key`（0-4，建議 CLUE-11~14）
- **額外線索**：`clues_bonus`（0-6）
- **警覺**：`A`（0-100）

### 3.2 真相分計算（見 `計分公式.md`）

```
t = round(45·F14 + 35·K4 + 10·X6 + 10·A100)
```

**分級**：
- **good**（80-100）：成功找出真相
- **mid**（55-79）：部分線索，接近真相
- **bad**（0-54）：未找出真相

### 3.3 推理選項

玩家可以選擇：

1. **相信某個嫌疑人**
   - 選擇：同事A / 主管 / 同事C
   - 結果：可能錯誤，但仍有結局

2. **懷疑所有人**
   - 選擇：懷疑所有人
   - 結果：可能找不到真相，但仍有結局

3. **找出真正的兇手**
   - 選擇：分析所有線索，找出真正的兇手
   - 結果：正確，可觸發所有結局選項

---

## 4) 結局類型與內容

### 4.1 完美結局（最佳結局）

**觸發條件**：
- `b >= 80`（行為改變成功）
- `t >= 80`（找出真相）
- 選擇：原諒 / 揭露

**結局內容**：

**職場關係**：
- 真相被揭露，你獲得認可，工作穩定
- 同事A和主管的霸凌被揭露
- 你不再被霸凌，職場名聲恢復

**辦公室戀情關係**：
- 關係被修復或結束，你不再被傷害
- 你被尊重，有人願意愛你
- 同事C意識到錯誤，或你選擇結束關係

**自我認同**：
- 你學會接住自己，建立內在力量
- 你不再依賴他人，獲得真正的救贖
- 你學會了「自我救贖」

**真相揭露**：
- 找出真正的兇手，選擇原諒或揭露
- 獲得正義和內心的平靜
- 你不再被霸凌，命運已經改變

**系統總結**（毒舌系統宣判）：
- 「你不再是那個被霸凌的人」
- 「你學會了揭露真相」
- 「你學會了設定界線」
- 「你學會了接住自己」
- 「你找出了真正的兇手」
- 「你選擇了原諒或揭露，獲得真正的救贖」
- 「你獲得了全新的未來」

**情感弧線**：從「下降」到「上升」，從「絕望」到「希望」，從「被動」到「主動」，從「未知」到「真相」，從「復仇」到「救贖」

---

### 4.2 成長結局（好結局）

**觸發條件**：
- `b >= 80`（行為改變成功）
- `t < 80`（未找出真相）

**結局內容**：

**職場關係**：
- 你改變了自己的行為模式，自然改變了與他人的關係
- 你獲得認可，工作穩定
- 雖然沒找出真相，但你已經改變了命運

**情人關係**：
- 你學會設定界線，關係變得健康
- 你被尊重，有人願意愛你
- 雖然沒找出真相，但你已經改變了命運

**自我認同**：
- 你學會接住自己，建立內在力量
- 你不再依賴他人，獲得新生
- 雖然沒找出真相，但你已經改變了命運

**系統總結**：
- 「你不再是那個被霸凌的人」
- 「你學會了設定界線」
- 「你學會了接住自己」
- 「雖然沒找出真相，但你已經改變了命運」
- 「你獲得了全新的未來」

**情感弧線**：從「下降」到「上升」，從「絕望」到「希望」，從「被動」到「主動」

---

### 4.3 復仇結局（中性結局）

**觸發條件**：
- `b >= 55`（行為部分改變）
- `t >= 80`（找出真相）
- 選擇：復仇

**結局內容**：

**職場關係**：
- 真相被揭露，你獲得認可，工作穩定
- 同事A和主管的霸凌被揭露

**情人關係**：
- 關係被修復或結束，你不再被傷害

**自我認同**：
- 你學會接住自己，建立內在力量
- 但選擇了復仇路線

**真相揭露**：
- 找出真正的兇手，讓兇手過得很慘
- 獲得復仇的快感，但內心可能仍然空虛

**系統總結**：
- 「你不再是那個被霸凌的人」
- 「你學會了揭露真相」
- 「你學會了設定界線」
- 「你學會了接住自己」
- 「你找出了真正的兇手」
- 「你選擇了復仇，讓兇手過得很慘」
- 「但你的內心可能仍然空虛，因為復仇無法帶來真正的救贖」

**情感弧線**：從「下降」到「上升」，從「絕望」到「希望」，從「被動」到「主動」，從「未知」到「真相」，但「復仇」可能帶來空虛

---

### 4.4 悲劇結局（壞結局）

**觸發條件**：
- `b < 55`（未成功改變行為）
- `t >= 80`（找出真相）

**結局內容**：

**職場關係**：
- 你仍然被霸凌，即使知道真相也無法改變
- 你仍然過度討好、害怕衝突、依賴他人

**情人關係**：
- 你仍然被傷害，即使知道真相也無法改變

**自我認同**：
- 你仍然依賴他人，沒有建立內在力量

**真相揭露**：
- 找出真正的兇手，但沒有改變自己的行為模式
- 無法改變命運

**系統總結**：
- 「你仍然是那個被霸凌的人」
- 「你找出了真正的兇手，但沒有改變自己的行為模式」
- 「即使知道真相，你也無法改變命運」
- 「你仍然走向悲劇，只是帶著真相死去」

**情感弧線**：從「下降」到「下降」，從「絕望」到「絕望」，即使找出真相也無法改變

---

### 4.5 失敗結局（最壞結局）

**觸發條件**：
- `b < 55`（未成功改變行為）
- `t < 80`（未找出真相）

**結局內容**：

**職場關係**：
- 你仍然被霸凌，重複了原本的悲劇

**情人關係**：
- 你仍然被傷害，重複了原本的悲劇

**自我認同**：
- 你仍然依賴他人，沒有建立內在力量

**真相揭露**：
- 沒有找出真正的兇手，帶著疑問和絕望死去

**系統總結**：
- 「你仍然是那個被霸凌的人」
- 「你沒有改變自己的行為模式」
- 「你沒有找出真正的兇手」
- 「你重複了原本的悲劇」
- 「你帶著疑問和絕望死去」

**情感弧線**：從「下降」到「下降」，從「絕望」到「絕望」，完全重複了原本的悲劇

---

## 5) 結局選擇與後續處理

### 5.1 結局選擇 UI

```
┌─────────────────────────────────┐
│  你把自己接住了                  │
├─────────────────────────────────┤
│  真相與你留下的痕跡，會決定你    │
│  最後怎麼收場。                  │
├─────────────────────────────────┤
│  行為分：{b}/100                │
│  真相分：{t}/100                │
│  創傷分：{scar}/100             │
│  回溯次數：{rewinds}            │
├─────────────────────────────────┤
│  [揭露] [復仇] [走開]           │
└─────────────────────────────────┘
```

### 5.2 結局選擇限制

- **揭露**：需要 `t >= 80`（找出真相）
- **復仇**：需要 `t >= 80`（找出真相）
- **走開**：無限制（任何情況下都可選擇）

### 5.3 結局選擇後的處理

**揭露**：
- 顯示揭露真相的畫面
- 毒舌系統評價（見 `介面字串表.md`）
- 結局總結

**復仇**：
- 顯示復仇的畫面
- 毒舌系統評價（見 `介面字串表.md`）
- 結局總結

**走開**：
- 顯示走開的畫面
- 毒舌系統評價（見 `介面字串表.md`）
- 結局總結

---

## 6) 毒舌系統的結局宣判

### 6.1 宣判流程（見 `介面字串表.md`）

**動態 1-5 句，最後一句必定肯定你**

1. **第 1 句（必選）**：`copy.tongue.judge.header`
   - 「【宣判】行為：{b}／真相：{t}」

2. **第 2 句（擇一）**：行為評語（依 `{b}` good/mid/bad 抽一條）

3. **第 3 句（擇一）**：真相評語（依 `{t}` good/mid/bad 抽一條）

4. **第 4 句（可選）**：創傷評語（若 `{rewinds} >= 3` 或 `{scar} >= 60`，抽一條）

5. **第 5 句（必選，收尾肯定）**：`copy.tongue.ending.affirm.*`（永遠放最後）

### 6.2 結局分支評價

**揭露**（`cta.reveal` 後）：
- `copy.tongue.ending.reveal.good.1`：你把名字說出來了。你沒有再替他們保密。
- `copy.tongue.ending.reveal.mid.1`：你選了揭露，但你還在顫。別裝，你怕的不是他，是你自己。
- `copy.tongue.ending.reveal.bad.1`：你喊揭露，卻沒拿得出手的東西。你只是想有人替你出頭。

**復仇**（`cta.revenge` 後）：
- `copy.tongue.ending.revenge.good.1`：你讓他們付出代價。不是為了爽，是為了終止循環。
- `copy.tongue.ending.revenge.mid.1`：你說你在復仇，其實你只是不想承認你還在痛。
- `copy.tongue.ending.revenge.bad.1`：你把自己也燒進去。你贏了場面，輸了自己。

**走開**（`cta.leave` 後）：
- `copy.tongue.ending.leave.good.1`：你走開不是逃。你是把自己帶走，從此不再回頭求愛。
- `copy.tongue.ending.leave.mid.1`：你走開了，但你還在等一句道歉。等不到的。
- `copy.tongue.ending.leave.bad.1`：你走開只是躲。你把真相也一起丟在路邊。

### 6.3 最後一句（收尾肯定）

**永遠放最後，必定肯定你**：
- `copy.tongue.ending.affirm.1`：你不需要被誰原諒。你已經開始原諒自己了。
- `copy.tongue.ending.affirm.2`：你撐過來了。這一次，你沒有丟下你自己。
- `copy.tongue.ending.affirm.3`：你值得。不是因為你贏了，是因為你終於站著。

---

## 7) 結局畫面的具體呈現

### 7.1 結局畫面結構

```
┌─────────────────────────────────┐
│  [背景：改變後的人生場景]        │
├─────────────────────────────────┤
│  [對比畫面：原本 vs 改變後]      │
├─────────────────────────────────┤
│  [文字總結]                      │
│  • 職場關係：...                 │
│  • 情人關係：...                 │
│  • 自我認同：...                 │
│  • 真相揭露：...                 │
├─────────────────────────────────┤
│  [毒舌系統宣判]                  │
│  （動態 1-5 句）                 │
├─────────────────────────────────┤
│  [結局選擇按鈕]                  │
│  [揭露] [復仇] [走開]           │
└─────────────────────────────────┘
```

### 7.2 結局畫面設計原則

- **對比強烈**：原本 vs 改變後的視覺對比
- **情感投入**：通過畫面、文字、音效傳達情感
- **沉浸感**：不使用「遊戲/關卡/玩家」等出戲詞
- **第一人稱**：使用「你」的視角

---

## 8) 結局系統的技術實現

### 8.1 數據存儲（Firestore）

```typescript
// /users/{userId}/ending
interface UserEnding {
  userId: string;
  behaviorScore: number;        // b (0-100)
  truthScore: number;           // t (0-100)
  scarScore: number;            // scar (0-100)
  rewindsTotal: number;         // rewinds
  endingType: 'perfect' | 'growth' | 'revenge' | 'tragedy' | 'failure';
  endingChoice: 'reveal' | 'revenge' | 'leave';
  truthInference: 'found' | 'partial' | 'not_found';
  completedAt: Timestamp;
}
```

### 8.2 API 端點

```typescript
// 計算結局分數
POST /api/ending/calculate
Body: { userId: string }
Response: { b, t, scar, rewinds, endingType }

// 選擇結局
POST /api/ending/choose
Body: { userId: string, choice: 'reveal' | 'revenge' | 'leave' }
Response: { endingContent: string, tongueVerdict: string[] }
```

### 8.3 前端實現

- **結局頁面組件**：`EndingPage.tsx`
- **結局選擇組件**：`EndingChoice.tsx`
- **毒舌宣判組件**：`TongueVerdict.tsx`
- **狀態管理**：`endingStore.ts`（Zustand）

---

## 總結

結局系統的完整實現包括：

1. **觸發條件**：完成所有時刻 + 行為改變評估 + 真相推理
2. **結局類型**：完美、成長、復仇、悲劇、失敗
3. **結局內容**：職場、情人、自我、真相的具體呈現
4. **結局選擇**：揭露、復仇、走開
5. **毒舌宣判**：動態 1-5 句，最後一句必定肯定你
6. **技術實現**：Firestore 存儲、API 端點、前端組件

建議按照階段逐步實施，先實現基礎的結局判定和顯示，再逐步完善毒舌宣判和結局選擇。

